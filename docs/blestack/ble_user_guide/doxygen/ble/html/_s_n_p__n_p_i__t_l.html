<!-- HTML header for doxygen 1.8.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<title>TI BLE-Stack for Bluetooth 4.2 API Documentation: SNP NPI Transport Layer (UART/SPI)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="tiapistylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table width="100%">
<tr>
  <td bgcolor="black" width="1"><a href="http://www.ti.com"><img border="0" src="tilogo.gif" /></a></td>
  <td bgcolor="red"><img src="titagline.gif" /></td>
</tr>
</table>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TI BLE-Stack for Bluetooth 4.2 API Documentation
   &#160;<span id="projectnumber">3.01.00.05</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">SNP NPI Transport Layer (UART/SPI) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Network Processor Interface(NPI) is what is used to communicate between the AP and NP. Check <a href="http://processors.wiki.ti.com/index.php/Unified_Network_Processor_Interface">http://processors.wiki.ti.com/index.php/Unified_Network_Processor_Interface</a> for up to date information.</p>
<p>The NPI Transport Layer can be driven by UART or SPI. The protocol used is the updated version of the current TI NPI framework.</p>
<p>The NPI framework uses this frame format (the same frame is use for UART or SPI):</p>
<table class="doxtable">
<tr>
<th>SOF </th><th>Length </th><th>Cmd0 </th><th>Cmd1 </th><th>Data Payload </th><th>FCS  </th></tr>
<tr>
<td>1 Byte (0xFE) </td><td>2 bytes </td><td>1 byte </td><td>1 Byte </td><td>0-4096 bytes </td><td>1 Byte </td></tr>
</table>
<p><b>SOF:</b> start of Frame (1 byte). <br />
 <b>Length:</b> length of the data payload field (2 bytes). <br />
 <b>Cmd0:</b> the opcode is split in 2 field:</p><ul>
<li>Type (3 bits): synchronous req (0x1), asynchronous req (0x2), synchronous response (0x3) ( see <a class="el" href="group___s_n_p___n_p_i___t_y_p_e.html">NPI frame type for SNP (NPI cmd 0)</a>) <br />
</li>
<li>Subsystem (5 bits): the subsystem for which the command belongs to ( BLE SNP subsystem (0x15 or 21) ). <br />
 <b>Cmd1:</b> type of command, or command (8 bits) <br />
 <b>Payload:</b> the command itself (or extension of the command). <br />
 <b>FCS:</b> frame check sequence, calculated on all field except SOF. <br />
 Using this NPI frame and protocol makes it easier to reuse existing code from other technologies (or use combine technologies), like ZigBee-RF4CE.</li>
</ul>
<p>The subsystem used is the BLE SNP subsystem (0x15 or 21).</p>
<p>The API field is composed of a header subfield and an opcodeId subfield. The header subfield is 2 bits long and is used to indicate the group of APIs the command belongs to:</p>
<table class="doxtable">
<tr>
<th align="center">Opcode Subgroup </th><th>Description  </th></tr>
<tr>
<td align="center">0 </td><td>SNP Device </td></tr>
<tr>
<td align="center">1 </td><td>SNP GAP (adv. and connection) </td></tr>
<tr>
<td align="center">2 </td><td>SNP GATT Services management </td></tr>
<tr>
<td align="center">3 </td><td>reserved </td></tr>
</table>
<p>SNP Frame description:</p>
<p>For a SNP Frame , the command opcode is the first byte of the param section.</p>
<table class="doxtable">
<tr>
<th>SOF </th><th>Length </th><th>Cmd0 </th><th>Cmd1 </th><th>Data Payload </th><th>FCS  </th></tr>
<tr>
<td>1 Byte (0xFE) </td><td>2 bytes </td><td>1 byte, <br />
 bits 5-7: type, <br />
 bits 0-4: subsystem (21 for BLE) </td><td>1 Byte </td><td>0-4096 bytes </td><td>1 Byte </td></tr>
</table>
<h1><a class="anchor" id="TL_Parameter"></a>
Dealing with Parameters and Packed Structures</h1>
<p>Most commands accept parameters. For convenience, parameters of each command are described through packed structures. Some parameter take variable parameter size. A variable field is described as a pointer in the corresponding structure. There is only one variable length field per command. This field is put at the end of the structure. The length of this field is generally not indicated, but can be retrieve easily by reading the length of the whole frame.</p>
<p>The obvious consequence is that the total parameters size is not necessary equal to the size of the structure, rather a variable length parameter (the pointer) is present in the structure. Since a pointer doesn't make sense to be send over a transport protocol (UART/SPI), it represents a place holder for the real data. It can be considered as the location in the frame where the information pointed too by the pointer starts being transmitted. Also, since the maximum of only one pointer per structure, the size of the data pointed to can be deduced from the global frame length with knowledge of the other parameters in the structure.</p>
<p>For Example: <a class="el" href="group___s_n_p___g_a_p.html#ga661d29b14fb21b2a8f2fd3d6e872bfc3">SNP_setAdvData</a> needs to be sent to the SNP, with type <a class="el" href="group___s_n_p___advbuffer.html#ga445653f5e5fc0213128e343d5b6fb52c" title="data buffer holding the scanning response ">SNP_SCANRSP_DATA</a> and raw data "0x00 0x01 0x02" The structure <a class="el" href="structsnp_set_adv_data_req__t.html" title="Parameter Structure for SNP_setAdvData. ">snpSetAdvDataReq_t</a> is used to represent the data over UART.</p>
<div class="fragment"><div class="line">PACKED_TYPEDEF_STRUCT</div><div class="line">{</div><div class="line">  uint8_t type;         </div><div class="line">  uint8_t *pData;       </div><div class="line">} <a class="code" href="structsnp_set_adv_data_req__t.html">snpSetAdvDataReq_t</a>;</div></div><!-- fragment --><p>the frame send over UART/SPI will be the following: </p><table class="doxtable">
<tr>
<th>SOF </th><th>Length </th><th>Cmd0 </th><th>Cmd1 </th><th>Type </th><th>data </th><th>FCS  </th></tr>
<tr>
<td>0xFE </td><td>0x04 0x00 bytes </td><td><a class="el" href="group___s_n_p___n_p_i___t_y_p_e.html#ga9baba627781c846634ce07570d2e8dc1" title="(0x55) Asynchronous Command type for the BLE simple network processor (cmd0 field of npi frame) ...">SNP_NPI_ASYNC_CMD_TYPE</a> </td><td><a class="el" href="group___s_n_p___g_a_p___c_m_d___l_i_s_t.html#gac2dc8881b09d861be6eaf8cd9949a72f" title="SNP GAP Set Adv Data Request. ">SNP_SET_ADV_DATA_REQ</a> </td><td><a class="el" href="group___s_n_p___advbuffer.html#ga445653f5e5fc0213128e343d5b6fb52c" title="data buffer holding the scanning response ">SNP_SCANRSP_DATA</a> </td><td>0x00 0x01 0x02 </td><td>the Fcs </td></tr>
</table>
<p>Note that all field needs to use the little endian format (except for variable length field where they are read in the order they arrive on the bus.).</p>
<h1><a class="anchor" id="UUID_desc"></a>
dealing with UUID</h1>
<p>UUID can be 2 bytes long or 16 bytes long. each services and each characteristics have its own UUID. UUID are send LSB first over UART.</p>
<p>in order to save memory when a lot of service are created, some predefined UUID are store in flash area of the SNP code. if one of those UUID is recognize in a service or characteristic, the version located in flash will be used.</p>
<p>Also, the SNP will do the following :</p><ul>
<li>if the UUID send assign to a service/characteristic is a long (16 bytes) BT BASE UUID, and the SNP has a short version of this UUID, then SNP will replace the long version by a short version.</li>
<li>if the UUID send assign to a service/characteristic is a short (2 bytes) HAP BASE UUID , and the SNP recognize it, it will automatically replace it by the long version of the UUID. </li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<hr class="footer"/><small>
Copyright  2017, Texas Instruments Incorporated
</small>
</body>
</html>
