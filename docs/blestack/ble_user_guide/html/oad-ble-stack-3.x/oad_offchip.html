

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Off-Chip OAD &mdash; BLE-Stack User&#39;s Guide for Bluetooth 4.2 3.01.00.05 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="BLE-Stack User&#39;s Guide for Bluetooth 4.2 3.01.00.05 documentation" href="../index.html"/>
        <link rel="up" title="Over the Air Download (OAD)" href="oad.html"/>
        <link rel="next" title="On-Chip OAD" href="oad_onchip.html"/>
        <link rel="prev" title="OAD Profile" href="oad_profile.html"/> 
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug oad-ble-stack-3.x oad_offchip";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script> 

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8">     


  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../ble-stack-3.x-guide/index.html" class="icon icon-home"> BLE-Stack User's Guide for Bluetooth 4.2
          

          
          </a>

          
            
            
              <div class="version">
                3.01.00.05
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../cc2640/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/get-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc2640/platform.html">The CC2640R2F SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x/index.html">Developing a Bluetooth Low Energy Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../u-stack/index.html">Micro BLE Stack</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="oad.html">Over the Air Download (OAD)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="oad_concepts.html">OAD Concept Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="oad_profile.html">OAD Profile</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Off-Chip OAD</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#supported-stack-image-types">Supported Stack Image Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constraints-and-requirements-for-off-chip-oad">Constraints and Requirements for Off-chip OAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="#off-chip-oad-memory-layout">Off-chip OAD Memory layout</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#external-flash-metadata">External Flash Metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">External Flash Metadata</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bim-for-off-chip-oad">BIM for Off-chip OAD</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#finding-the-last-flash-page-containing-flash-metadata">Finding the last flash page containing flash metadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="#forced-image-copy">Forced Image Copy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#out-of-the-box-demo-off-chip-app-only-oad">Out of the Box Demo (Off-Chip App Only OAD)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-ccs">Using CCS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-iar">Using IAR</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#add-off-chip-oad-to-an-existing-project">Add Off-chip OAD to an existing project</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="oad_onchip.html">On-Chip OAD</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../voice/voice.html">Creating a Voice Enabled Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../secure-fw-3.x/index.html">Secure Firmware (SFW)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging/ble-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/migration.html">Migration Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/api-reference.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-3.x-guide/reference.html">Terms and Definitions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../ble-stack-3.x-guide/index.html">BLE-Stack User's Guide for Bluetooth 4.2</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../ble-stack-3.x-guide/index.html">Docs</a> &raquo;</li>
        
          <li><a href="oad.html">Over the Air Download (OAD)</a> &raquo;</li>
        
      <li>Off-Chip OAD</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="off-chip-oad">
<span id="sect-off-chip-oad"></span><h1>Off-Chip OAD<a class="headerlink" href="#off-chip-oad" title="Permalink to this headline">¶</a></h1>
<p>This section describes the TI Off-chip OAD implementation.
Off-chip OAD utilizes an external memory component (Flash) to store the new
image during download and image selection/update.</p>
<p>The following procedures are unique to Off-chip OAD:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#sect-off-chip-limitations"><span class="std std-ref">Constraints and Requirements for Off-chip OAD</span></a></li>
<li><a class="reference internal" href="#sect-off-chip-bim-memory-layout"><span class="std std-ref">Off-chip OAD Memory layout</span></a></li>
<li><a class="reference internal" href="#sect-bim-for-off-chip-oad"><span class="std std-ref">BIM for Off-chip OAD</span></a></li>
<li><a class="reference internal" href="#sect-off-chip-demo"><span class="std std-ref">Out of the Box Demo (Off-Chip App Only OAD)</span></a></li>
<li><a class="reference internal" href="#sect-off-chip-add-to-proj"><span class="std std-ref">Add Off-chip OAD to an existing project</span></a></li>
</ul>
</div></blockquote>
<p>For information about the OAD profile and image header, please see
<a class="reference internal" href="oad_concepts.html#sec-oad-concepts"><span class="std std-ref">OAD Concept Overview</span></a>.</p>
<p>For information about the TI OAD Sample Applications that showcase On-Chip OAD,
see <a class="reference internal" href="oad_concepts.html#oad-projects-overview"><span class="std std-ref">OAD Projects Overview.</span></a>.</p>
<div class="section" id="supported-stack-image-types">
<span id="sec-library-off-chip-oad"></span><h2>Supported Stack Image Types<a class="headerlink" href="#supported-stack-image-types" title="Permalink to this headline">¶</a></h2>
<p>Off-chip OAD supports the split image build configuration. Stack library image
types can be upgraded through Off-chip OAD but that is outside the scope of this
document.</p>
<p>Off-chip OAD supports Application Only, Stack Only, or App + Stack Merged OADs.
This means that the user can update both the application and stack during
the same OAD session.</p>
<blockquote>
<div></div></blockquote>
</div>
<div class="section" id="constraints-and-requirements-for-off-chip-oad">
<span id="sect-off-chip-limitations"></span><h2>Constraints and Requirements for Off-chip OAD<a class="headerlink" href="#constraints-and-requirements-for-off-chip-oad" title="Permalink to this headline">¶</a></h2>
<p>In order to perform an Off-chip OAD the target system must contain have:</p>
<blockquote>
<div><ul class="simple">
<li>An off-chip flash storage of at least 124kB and space for storing external
flash image header block is required for a full flash update. One flash page
(4Kb) is occupied by BIM. A serial connection (SPI) is used to communicate
with the off-chip flash component.</li>
<li>Free GPIO pins to interface to the external memory (i.e. 4 wires for SPI)</li>
<li>Enough free code space to reserve the entire contents of pg 31 (4kB) for
<a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-44"><span class="xref std std-term">BIM</span></a></li>
<li>The OAD Image to be downloaded to the off-chip flash memory can be an
application image, a stack image, a combined application plus stack, an
image intended for the upgrade of a network processor, or any type of image
as far as it is supposed to eventually replace any part of the on-chip 120kB
area between the first page and the penultimate page. More than one image
can be downloaded before the system reset followed by BIM’s copying the
downloaded images from the off-chip flash memory to the on-chip flash memory.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="off-chip-oad-memory-layout">
<span id="sect-off-chip-bim-memory-layout"></span><h2>Off-chip OAD Memory layout<a class="headerlink" href="#off-chip-oad-memory-layout" title="Permalink to this headline">¶</a></h2>
<p>The memory maps for both internal and external flash are detailed below.</p>
<div class="figure align-center" id="id3">
<span id="fig-off-chip-oad-target-memory-partition"></span><img alt="../_images/offchip_oad_mem_layout.png" src="../_images/offchip_oad_mem_layout.png" />
<p class="caption"><span class="caption-number">Figure 84. </span><span class="caption-text">Off-Chip OAD Memory Layout</span></p>
</div>
<p>Off-chip OAD applications use the both internal flash memory and an off-chip
flash memory device. The internal flash memory contains the Interrupt Vectors
(part of the User Application space),
the Application where OAD Profile is embedded, the BLE stack image,
the NV Storage Area, the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-44"><span class="xref std std-term">BIM</span></a> and the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-ccfg"><span class="xref std std-term">CCFG</span></a>.</p>
<p>The off-chip flash memory on the <a class="reference external" href="http://www.ti.com.cn/tool/launchxl-cc2640r2">CC2640R2 Launchpad</a> contains up to 3 OAD Images and up to 3
metadata vectors corresponding to the OAD Images. The memory map layout of the
external flash part is defined in <code class="code docutils literal"><span class="pre">ext_flash_layout.h</span></code>. The size of each
OAD Image placeholder is 128kB. The memory partition of the application for
Off-chip OAD is depicted in <a class="reference internal" href="#fig-off-chip-oad-target-memory-partition"><span class="std std-numref">Figure 84.</span></a>.
Each OAD image, either App only or App+Stack, must support OAD Profile so that
further OAD is enabled after it is downloaded to the off-chip memory, copied to
the on-chip memory, and executed.</p>
<p>The sectors in <a class="reference internal" href="#fig-off-chip-oad-target-memory-partition"><span class="std std-numref">Figure 84.</span></a> in red are
designed to be permanently resident on the device. The BIM and CCFG are not
intended to be upgraded via OAD. The OAD design was selected this way so that
a failure during the OAD process does not yield a bricked device.</p>
<div class="section" id="external-flash-metadata">
<h3>External Flash Metadata<a class="headerlink" href="#external-flash-metadata" title="Permalink to this headline">¶</a></h3>
<p>The external flash metadata is an array of structures containing OAD
downloadable information. Each structure will be stored at the start of
a separate flash page to aid easy modification of an individual structure while
retaining rest of the structures intact. The metadata header
fields are identical to the image header with the following modifications:.</p>
<blockquote>
<div><ul class="simple">
<li>OAD Image Identification Value is a different unique number than in the image
header. BIM uses this number to find the flash page containing external flash
metadata. This document will refer to this value as External Flash Image
Identification Value</li>
<li>Instead of Boundary Information and Contiguous Image information, the header
length field is followed by the to the flash address where the actual OAD
image is stored on the external flash.
Note: The OAD client will calculate the storage address, by reading valid
external image metadata from the image metadata array, and finding the next
available storage area.</li>
</ul>
</div></blockquote>
<p>After storing the image on the external flash, the
OAD application will set the Image Copy status to 0xFE if it needs to be copied
to the on-chip flash. To identify the latest image to be downloaded on the
on-chip flash, BIM will read the ‘Image copy status’ field of the metadata array.
There should be only one image with a value of 0xFE as BIM will copy the first
image with metadata status to be copied. The BIM will modify the state to 0xFC
when it is done copying image to on-chip flash.</p>
</div>
<div class="section" id="id2">
<h3>External Flash Metadata<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The external flash metadata pages and the image storage will grow in opposite
directions. To make the implementation more generic, each external
flash metadata will store the 8 byte External Flash Image Identification Value at
the beginning of the external flash metadata. If a BLE factory image is stored at
first flash pages then, metadata storage would start at flash page next to the
end of the image. The external flash metadata’ storage location are not fixed
and BIM can find their location by reading the first eight bytes of every
external flash page. For efficient BIM implementation, the OAD external flash
metadata will be stored from flash page 0 onwards.</p>
<p>It would be application’s responsibility to find the available free storage for
storing the newly downloaded image on the external flash.
The image metadata area will contain the image header information for the stored
OAD images with the modifications specified above.</p>
<p>Factory programmed BLE and other images will have OAD download capability but
will not be replaceable by over the air upgrade. The user application can choose
to switch to factory image. The length and location of the user defined area is
configurable and will have the image metadata header like any other image.</p>
<p>The OAD target application gathers part of the external flash metadata
information from image header and stores on the available metadata
page except for the &#8216;CRC Status&#8217; byte. The &#8216;CRC Status&#8217; byte is updated at the
last when all the image payload is stored on the flash and
calculated CRC matched with the one embedded in the image header.</p>
<p>The rest of the available space can be used in two possible ways:</p>
<blockquote>
<div><ul class="simple">
<li>By allocating the dedicated memory area between OAD images types</li>
<li>Using area to store multiple images of variable length.</li>
</ul>
</div></blockquote>
<p>The second approach is more efficient in term of memory space usage. It
requires the OAD client application to read the metadata information to figure
out the length and location of available memory space. The number of co-existing
OAD images will depend on individual image size and available area on the
external flash.</p>
<p>If there is no space left for the new image, OAD client/target
application can re-use the oldest image storage area to replace with new one.
This can result in fragmentation. This requires time stamping the images,
which can be done by simply by incorporating the counter in external flash
metadata header and incrementing it every time the image is
downloaded.</p>
<p>If application stores multiple images on the external flash, it can choose to
enable a specific one of them by issuing the ‘enable’ command
at OAD control point of by specifying the respective parameters
(‘Image type’, &#8216;image number&#8217;, etc.) it wishes to activate. The active
application can read the existing metadata to identify the correct image by
reading the Image ID, and updating the status to 0xFE.</p>
<p>The application can reuse the used metadata and actual image storage flash pages
by erasing it to support downloading and storage of
multiple images without having a dedicated storage area for each image type.</p>
</div>
</div>
<div class="section" id="bim-for-off-chip-oad">
<span id="sect-bim-for-off-chip-oad"></span><h2>BIM for Off-chip OAD<a class="headerlink" href="#bim-for-off-chip-oad" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-44"><span class="xref std std-term">BIM</span></a> will link the resident <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-ccfg"><span class="xref std std-term">CCFG</span></a> sector. Furthermore,
this is a custom CCFG, with the <code class="code docutils literal"><span class="pre">IMAGE_VALID_CONF</span></code> field set to
0x1F000. This means that the boot ROM of the device will automatically
execute <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-44"><span class="xref std std-term">BIM</span></a> code instead of application code at startup. <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-44"><span class="xref std std-term">BIM</span></a>
will handle starting the application. OAD applications will not need to
include a <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-ccfg"><span class="xref std std-term">CCFG</span></a>. This is a feature of CC2640R2F, and not compatible
with CC2650 devices.</p>
</div>
<p>The OAD solution requires that permanently resident boot code, the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-44"><span class="xref std std-term">BIM</span></a>,
exists in order to provide a fail-safe mechanism for determining whether
to run the existing application image or to copy a new image or images
from off-chip flash to internal flash (code) memory. It is assumed that a valid
image exists either in off-chip flash ready to be copied or already placed in
on-chip flash at any given time. Given this assumption, the initial
image placed in internal flash which does not exist in external flash
will have invalid external image metadata, and so the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-44"><span class="xref std std-term">BIM</span></a> will
choose to jump to the existing image’s entry point.</p>
<p>At startup, BIM finds the location of image metadata header flash page by
iterating through each page of external flash starting from page 0, by reading
the first 8 bytes to find the valid External Flash Image Identification value.
After locating the image metadata information, it verifies the
compatibility of BIM and metadata versions. Then it checks if the &#8216;Image copy
status&#8217; is set to be copied to the on-chip flash(0xFE) and has a valid
CRC (CRC status=0xFE). If it is, copies the image to on-chip flash, as per the
image copy procedure. If any other status value is found the image will
not be verified or copied to internal flash.</p>
<p>If it finds status &#8216;CRC not calculated&#8217;(CRC Status = 0xFF), it calculates the
CRC and updates the CRC status byte accordingly. If it finds the valid
CRC status, it copies the image to on-chip flash starting at the address pointed
by &#8216;Start Address&#8217; in image header of the image payload. On
finding the invalid CRC it moves on to read the next image metadata. If BIM
reaches the end of metadata without finding a valid image, then it will try to
find an on-chip image and execute it. BIM will put the device to low power
mode if it fails to find a valid application image.</p>
<p>An image is considered bad/invalid if it&#8217;s calculated CRC32 does not match with
the image&#8217;s CRC bytes embedded in the image header.</p>
<div class="figure align-center" id="id4">
<span id="functional-overview-of-offchip-bim"></span><img alt="../_images/offchip_oad_bim.png" src="../_images/offchip_oad_bim.png" />
<p class="caption"><span class="caption-number">Figure 85. </span><span class="caption-text">Functional Overview of Off-chip BIM</span></p>
</div>
<div class="section" id="finding-the-last-flash-page-containing-flash-metadata">
<h3>Finding the last flash page containing flash metadata<a class="headerlink" href="#finding-the-last-flash-page-containing-flash-metadata" title="Permalink to this headline">¶</a></h3>
<p>In the normal condition when there are empty flash pages, the OAD client
application will write the image metadata to the very first available flash
page sequentially starting from flash page 0 as shown in the external flash
layout. It is recommended that the application leaves least one empty
flash page between metadata pages and stored image at any point in time. If the
application encounters such a condition that no empty flash
page is left in between the stored image pages and image metadata page, it should
reuse the flash metadata pages by erasing one metadata page
at a time and writing the new one. If all metadata pages are used
or there would only one be empty page between the metadata pages and the image
payload then the older metadata pages should be erased and reused.</p>
</div>
<div class="section" id="forced-image-copy">
<h3>Forced Image Copy<a class="headerlink" href="#forced-image-copy" title="Permalink to this headline">¶</a></h3>
<p>BIM will implement this optional feature based on the hardware capability, to
forcibly copy a designated image from external flash to on-chip
flash(using button combinations). It would help recover the target in case an
invalid image has been copied on onchip flash which left the device
unresponsive. This feature is disabled by default as this
can pose a security risk.</p>
</div>
</div>
<div class="section" id="out-of-the-box-demo-off-chip-app-only-oad">
<span id="sect-off-chip-demo"></span><h2>Out of the Box Demo (Off-Chip App Only OAD)<a class="headerlink" href="#out-of-the-box-demo-off-chip-app-only-oad" title="Permalink to this headline">¶</a></h2>
<p>The SimpleLink CC2640R2 SDK includes demo projects that are setup to use OAD in advance. These
build configurations may be flashed onto the device out of the box. All out of
the box demos use BTool as the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-oad-downloader"><span class="xref std std-term">OAD Downloader</span></a>. Please see
<a class="reference internal" href="oad_concepts.html#sec-oad-topology"><span class="std std-ref">OAD Topology Overview</span></a> for more information. Ensure that BTool is setup
correctly first. See <a class="reference internal" href="oad_appendix.html#sec-oad-btool-setup"><span class="std std-ref">BTool Setup</span></a> for steps on how to do so.
The steps listed below assume that
a <a class="reference external" href="http://www.ti.com.cn/tool/launchxl-cc2640r2">CC2640R2 Launchpad</a> is being used. Additional steps may be required for custom hardware.</p>
<p>Furthermore, the steps in this section are referring to the
<a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-oad-target"><span class="xref std std-term">OAD Target</span></a> device, the images referenced below should be flashed onto
that device.</p>
<div class="section" id="using-ccs">
<h3>Using CCS<a class="headerlink" href="#using-ccs" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If both the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-oad-target"><span class="xref std std-term">OAD Target</span></a> and the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-oad-downloader"><span class="xref std std-term">OAD Downloader</span></a> are connected
at the same time, CCS may load the image to the wrong device. This is because
CCS will select the first XDS110 it finds. This behavior can be avoided by
unplugging the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-oad-target"><span class="xref std std-term">OAD Target</span></a> device, or by setting a multi emulator
debug session using CCS.
See the wiki <a class="reference external" href="http://processors.wiki.ti.com/index.php/Multi-Emulator_Debug_with_CCS">Debug with Multiple Emulators</a>
for more information.</p>
</div>
<p>The steps below will describe how to run the out of the box demo for OAD on CCS.</p>
<ol class="arabic">
<li><p class="first">Import the bim_oad_offchip, stack, and app projects into the workspace. This
can be done by importing the <code class="code docutils literal"><span class="pre">simple_peripheral_cc2640r2lp_oad_offchip_app</span></code>
project. It will automatically pull in the other projects it needs.</p>
<blockquote>
<div><div class="figure align-center" id="id5">
<span id="fig-offchip-oad-ccs-workspace"></span><img alt="../_images/offchip_oad_workspace_ccs.png" src="../_images/offchip_oad_workspace_ccs.png" />
<p class="caption"><span class="caption-number">Figure 86. </span><span class="caption-text">Offchip OAD CCS Workspace</span></p>
</div>
</div></blockquote>
</li>
<li><p class="first">Build and load the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-44"><span class="xref std std-term">BIM</span></a> project onto the <a class="reference external" href="http://www.ti.com.cn/tool/launchxl-cc2640r2">CC2640R2 Launchpad</a></p>
</li>
<li><p class="first">Build and load the <code class="code docutils literal"><span class="pre">simple_peripheral_cc2640r2lp_stack_oad_offchip</span></code>
project onto the <a class="reference external" href="http://www.ti.com.cn/tool/launchxl-cc2640r2">CC2640R2 Launchpad</a></p>
</li>
<li><p class="first">Build the and load the
<code class="code docutils literal"><span class="pre">simple_peripheral_cc2640r2lp_app_oad_offchip</span></code> project</p>
<blockquote>
<div><ul class="simple">
<li>Note that a special post build step will run and generate a new app image
file called <code class="code docutils literal"><span class="pre">simple_peripheral_cc2640r2lp_app_oad_offchip.bin</span></code>. This is the
file to be provided to BTool and sent over the air.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">You should now be able to observe that the device is advertising using BTool.</p>
<blockquote>
<div><ul class="simple">
<li>See <a class="reference internal" href="oad_appendix.html#sec-oad-btool-verify-adv"><span class="std std-ref">BTool OAD Verify Advertising</span></a> for steps.</li>
</ul>
<p>Note: The device will not advertise after a power cycle because the image as
loaded by CCS does not contain valid image header information. In order to
see the device after a power cycle. Use Smart RF Flash Programmer 2 to load
the *_oad_offchip.hex file.</p>
</div></blockquote>
</li>
<li><p class="first">Make your application level changes that are intended for OAD update.
Follow steps in <a class="reference internal" href="oad_appendix.html#sec-oad-adv-change"><span class="std std-ref">Changing Application Data to Verify an OAD</span></a> for a trivial way to change app to
verify the OAD. Build the application with changes.</p>
</li>
<li><p class="first">Use BTool to OAD your modified application file following the steps detailed in
<a class="reference internal" href="oad_appendix.html#sec-oad-btool-procedure"><span class="std std-ref">BTool OAD Procedure</span></a></p>
<blockquote>
<div><ul class="simple">
<li>Make sure you are using the *_oad_offchip.bin file with BTool as this
file contains the metadata.</li>
</ul>
</div></blockquote>
</li>
</ol>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">After a successful OAD, you may need to re-start your CC2640R2F in order for
it to advertise again. This is because the XDS110 driver may be still
attached from previous debug sessions.</p>
</div>
</div>
<div class="section" id="using-iar">
<h3>Using IAR<a class="headerlink" href="#using-iar" title="Permalink to this headline">¶</a></h3>
<p>The steps below will describe how to run the out of the box demo for OAD on IAR.</p>
<ol class="arabic">
<li><p class="first">Open the <code class="code docutils literal"><span class="pre">simple_peripheral_oad_offchip</span></code> workspace from the
simple_peripheral_oad_offchip folder within the BLE-stack examples. This will
import the BIM, stack, and application projects.</p>
<blockquote>
<div><ul class="simple">
<li>Build and load the BIM project</li>
<li>Build and load the stack project.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Build and load the <code class="code docutils literal"><span class="pre">simple_peripheral_oad</span></code> application project.</p>
</li>
<li><p class="first">You should now be able to observe that the device is advertising via BTool.</p>
<blockquote>
<div><ul class="simple">
<li>See <a class="reference internal" href="oad_appendix.html#sec-oad-btool-verify-adv"><span class="std std-ref">BTool OAD Verify Advertising</span></a> for steps.</li>
</ul>
<p>Note: The device will not advertise after a power cycle because the image as
loaded by IAR does not contain valid image header information. In order to
see the device after a power cycle. Use Smart RF Flash Programmer 2 to load
the *_oad_offchip.hex file.</p>
</div></blockquote>
</li>
<li><p class="first">Make your application level changes that are intended for OAD update.
Follow steps in <a class="reference internal" href="oad_appendix.html#sec-oad-adv-change"><span class="std std-ref">Changing Application Data to Verify an OAD</span></a> for a trivial way to change app to
verify the OAD. Build the application with changes.</p>
</li>
<li><p class="first">Use BTool to OAD your modified application file following the steps detailed in
<a class="reference internal" href="oad_appendix.html#sec-oad-btool-procedure"><span class="std std-ref">BTool OAD Procedure</span></a></p>
<blockquote>
<div><ul class="simple">
<li>Make sure you are using the *_oad.bin file with BTool as this file
contains the metadata. By default these images can be found at:</li>
</ul>
</div></blockquote>
</li>
</ol>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">After a successful OAD, you may need to re-start your CC2640R2F in order for
it to advertise again. This is because the XDS110 driver may be still
attached from previous debug sessions.</p>
</div>
</div>
</div>
<div class="section" id="add-off-chip-oad-to-an-existing-project">
<span id="sect-off-chip-add-to-proj"></span><h2>Add Off-chip OAD to an existing project<a class="headerlink" href="#add-off-chip-oad-to-an-existing-project" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All the following changes get applied to the application side.
Stack side should remain untouched for all OAD configurations.
For more information see <a class="reference internal" href="oad_appendix.html#sec-stack-side-changes-oad"><span class="std std-ref">Stack Side Changes for OAD Project</span></a>.</p>
</div>
<ol class="arabic">
<li><p class="first">Use <code class="code docutils literal"><span class="pre">bim_oad_offchip</span></code> project, as is. No change is required.</p>
</li>
<li><p class="first">Add OAD profile code to the application project:</p>
<blockquote>
<div><ul class="simple">
<li>The required files can be found in
<code class="code docutils literal"><span class="pre">\source\ti\blestack\profiles\oad\cc26xx</span></code><ul>
<li><code class="code docutils literal"><span class="pre">crc32.c</span></code></li>
<li><code class="code docutils literal"><span class="pre">crc32.h</span></code></li>
<li><code class="code docutils literal"><span class="pre">oad_image_header_app.c</span></code></li>
<li><code class="code docutils literal"><span class="pre">oad_image_header.h</span></code></li>
<li><code class="code docutils literal"><span class="pre">oad.c</span></code></li>
<li><code class="code docutils literal"><span class="pre">oad.h</span></code></li>
</ul>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Add External Flash support files to application project</p>
<blockquote>
<div><ul class="simple">
<li>The off-chip OAD projects rely on the ExtFlash module from
the middleware folder <code class="code docutils literal"><span class="pre">\source\ti\mw\extflash</span></code>. Add these files to
the application project.<ul>
<li><code class="code docutils literal"><span class="pre">ExtFlash.c</span></code></li>
<li><code class="code docutils literal"><span class="pre">ExtFlash.h</span></code></li>
</ul>
</li>
<li>Add the following files from <code class="code docutils literal"><span class="pre">\source\ti\blestack\common\cc26xx\flash_interface\external</span></code><ul>
<li><code class="code docutils literal"><span class="pre">flash_interface_ext_rtos.c</span></code></li>
<li><code class="code docutils literal"><span class="pre">flash_interface.h</span></code></li>
</ul>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Add the necessary include paths to the project:</p>
<blockquote>
<div><ul class="simple">
<li>The OAD profile code can be found at
<code class="code docutils literal"><span class="pre">\source\ti\blestack\profiles\oad\cc26xx</span></code></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Use the proper off-chip OAD linker file and configure it properly.</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>IAR projects should use:</dt>
<dd><code class="code docutils literal"><span class="pre">cc26xx_app_oad.icf</span></code> for App Only, App + Stack</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>CCS projects should use:</dt>
<dd><code class="code docutils literal"><span class="pre">cc26xx_app_oad.cmd</span></code> for App Only, App + Stack, Library</dd>
</dl>
</li>
</ul>
<p>For information on how to modify an existing linker command file for
OAD see <a class="reference internal" href="oad_appendix.html#sec-generating-oad-linker-file"><span class="std std-ref">Generating Linker Command File for OAD Off-chip</span></a>.</p>
</div></blockquote>
</li>
<li><p class="first">Add the following preprocessor defines to your application:</p>
<blockquote>
<div><ul class="simple">
<li>HAL_IMAGE_E</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Add necessary code to your high level application file to include OAD.</p>
<blockquote>
<div><ul>
<li><p class="first">Add the following defines to your application file (i.e. simple_peripheral)</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;oad_target.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;oad.h&quot;</span><span class="cp"></span>
<span class="c1">// ...</span>
<span class="cp">#define OAD_PACKET_SIZE                       ((OAD_BLOCK_SIZE) + 2)</span>
<span class="c1">// ...</span>
<span class="cp">#define SBP_QUEUE_PING_EVT                    Event_Id_02</span>

<span class="cp">#define SBP_ALL_EVENTS                        (SBP_ICALL_EVT        | \</span>
<span class="cp">                                               SBP_QUEUE_EVT        | \</span>
<span class="cp">                                               SBP_PERIODIC_EVT     | \</span>
<span class="cp">                                               SBP_CONN_EVT_END_EVT | \</span>
<span class="cp">                                               SBP_QUEUE_PING_EVT)</span>
</pre></div>
</div>
</li>
<li><p class="first">Add the following TI-RTOS Queue structures in your application:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="c1">// Event data from OAD profile.</span>
<span class="k">static</span> <span class="n">Queue_Struct</span> <span class="n">oadQ</span><span class="p">;</span>
<span class="k">static</span> <span class="n">Queue_Handle</span> <span class="n">hOadQ</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">Add a callback to your application</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">SimpleBLEPeripheral_processOadWriteCB</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">event</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">connHandle</span><span class="p">,</span>
                                           <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pData</span><span class="p">);</span>\
<span class="c1">// ...</span>
<span class="k">static</span> <span class="n">oadTargetCBs_t</span> <span class="n">simpleBLEPeripheral_oadCBs</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">SimpleBLEPeripheral_processOadWriteCB</span> <span class="c1">// Write Callback.</span>
<span class="p">};</span>
</pre></div>
</div>
</li>
<li><p class="first">Register the OAD service, initialize Queues.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">VOID</span> <span class="nf">OAD_addService</span><span class="p">();</span>                 <span class="c1">// OAD Profile</span>
<span class="n">OAD_register</span><span class="p">((</span><span class="n">oadTargetCBs_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">simpleBLEPeripheral_oadCBs</span><span class="p">);</span>
<span class="n">hOadQ</span> <span class="o">=</span> <span class="n">Util_constructQueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oadQ</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p class="first">Add the OAD Queue processing code to your application</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">SBP_QUEUE_PING_EVT</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Queue_empty</span><span class="p">(</span><span class="n">hOadQ</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">oadTargetWrite_t</span> <span class="o">*</span><span class="n">oadWriteEvt</span> <span class="o">=</span> <span class="n">Queue_get</span><span class="p">(</span><span class="n">hOadQ</span><span class="p">);</span>

    <span class="c1">// Identify new image.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">OAD_WRITE_IDENTIFY_REQ</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">OAD_imgIdentifyWrite</span><span class="p">(</span><span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">connHandle</span><span class="p">,</span> <span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Write a next block request.</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">OAD_WRITE_BLOCK_REQ</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">OAD_imgBlockWrite</span><span class="p">(</span><span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">connHandle</span><span class="p">,</span> <span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Free buffer.</span>
    <span class="n">ICall_free</span><span class="p">(</span><span class="n">oadWriteEvt</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Add an application layer OAD callback</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">SimpleBLEPeripheral_processOadWriteCB</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">event</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">connHandle</span><span class="p">,</span>
                                           <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pData</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">oadTargetWrite_t</span> <span class="o">*</span><span class="n">oadWriteEvt</span> <span class="o">=</span> <span class="n">ICall_malloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oadTargetWrite_t</span><span class="p">)</span> <span class="o">+</span> \
                                             <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">OAD_PACKET_SIZE</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">oadWriteEvt</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
    <span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">connHandle</span> <span class="o">=</span> <span class="n">connHandle</span><span class="p">;</span>

    <span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">pData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">pData</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">oadWriteEvt</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">,</span> <span class="n">pData</span><span class="p">,</span> <span class="n">OAD_PACKET_SIZE</span><span class="p">);</span>

    <span class="n">Queue_put</span><span class="p">(</span><span class="n">hOadQ</span><span class="p">,</span> <span class="p">(</span><span class="n">Queue_Elem</span> <span class="o">*</span><span class="p">)</span><span class="n">oadWriteEvt</span><span class="p">);</span>

    <span class="c1">// Post the application&#39;s event.  For OAD, no event flag is used.</span>
    <span class="n">Event_post</span><span class="p">(</span><span class="n">syncEvent</span><span class="p">,</span> <span class="n">SBP_QUEUE_PING_EVT</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Add the necessary arguments to your configuro script to relocate your app&#8217;s
reset vector address.</p>
<ul class="simple">
<li>Add <code class="code docutils literal"><span class="pre">OAD_IMG_E=1</span></code> to your &#8211;cfgArgs.
See <a class="reference internal" href="oad_appendix.html#sec-oad-reset-vect-change"><span class="std std-ref">Using a custom reset vector address for your application</span></a> for more information.</li>
</ul>
</li>
<li><p class="first">[Optional] On custom hardware, you may need to change the pinout of the
external flash part. This can be done in two steps:</p>
<blockquote>
<div><ul>
<li><p class="first">First, change the application layer code.</p>
<ul>
<li><p class="first">The application interfaces to the external SPI flash via
<code class="code docutils literal"><span class="pre">ExtFlash.c</span></code></p>
</li>
<li><p class="first">By default, the ExtFlash module uses <code class="code docutils literal"><span class="pre">Board_SPI0</span></code>, this can
be changed to <cite>Board_SPI0</cite></p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-number">Listing 86. </span><span class="caption-text">ExtFlash.c interface to SPI</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/* Attempt to open SPI. */</span>
<span class="n">spiHandle</span> <span class="o">=</span> <span class="n">SPI_open</span><span class="p">(</span><span class="n">Board_SPI0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spiParams</span><span class="p">);</span>
</pre></div>
</div>
</div>
</li>
<li><p class="first">The pins used by the <code class="code docutils literal"><span class="pre">Board_SPIX</span></code> group can be set in the board
file, i.e. CC2640R2_LAUNCHXL.c</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-number">Listing 87. </span><span class="caption-text">CC2640R2_LAUNCHXL.c SPI1 Pins</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">mosiPin</span>            <span class="o">=</span> <span class="n">CC2640R2_LAUNCHXL_SPI1_MOSI</span><span class="p">,</span>
<span class="p">.</span><span class="n">misoPin</span>            <span class="o">=</span> <span class="n">CC2640R2_LAUNCHXL_SPI1_MISO</span><span class="p">,</span>
<span class="p">.</span><span class="n">clkPin</span>             <span class="o">=</span> <span class="n">CC2640R2_LAUNCHXL_SPI1_CLK</span><span class="p">,</span>
<span class="p">.</span><span class="n">csnPin</span>             <span class="o">=</span> <span class="n">CC2640R2_LAUNCHXL_SPI1_CSN</span>
</pre></div>
</div>
</div>
</li>
<li><p class="first">The defines above can be set in CC2640R2_LAUNCHXL.h</p>
</li>
</ul>
</li>
<li><p class="first">Second, change the pins that the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-44"><span class="xref std std-term">BIM</span></a> uses to access the SPI flash.
This can be done in the <code class="code docutils literal"><span class="pre">bim_oad_offchip</span></code> project. Since BIM is a bare
metal program (no-RTOS). It doesn&#8217;t use the TI-RTOS SPI driver like the
application does. BIM SPI pins are set in
<code class="code docutils literal"><span class="pre">\examples\rtos\CC2640R2_LAUNCHXL\blestack\bim_oad_offchip\src\bsp.h</span></code></p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-number">Listing 88. </span><span class="caption-text">Off-chip OAD BIM interface to SPI</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="c1">// Board external flash defines</span>
<span class="cp">#define BSP_IOID_FLASH_CS       IOID_20</span>
<span class="cp">#define BSP_SPI_MOSI            IOID_9</span>
<span class="cp">#define BSP_SPI_MISO            IOID_8</span>
<span class="cp">#define BSP_SPI_CLK_FLASH       IOID_10</span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">[Optional] For App+Stack or Library OAD Images, trim <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a>/Unused Space</p>
<blockquote>
<div><p>Library and App+Stack can generate large OAD images especially if the
end application utilizes <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a>. (App + Stack will always be large)</p>
<p><a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a> can be preserved on the OAD Target device by applying the &#8216;-r&#8217;
command to the OAD Image Tool. The &#8216;-r&#8217; command will limit the output
image to within the range specified. Page alignment must still be
preserved, so some 0xFFs may be kept in the image.</p>
<p>For example, to preserve page 31, or a 1 page <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a>:
the <code class="docutils literal"><span class="pre">-r</span> <span class="pre">:1e000</span></code> command can be appended to the post build step:</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-number">Listing 89. </span><span class="caption-text">Modified IAR post-build step to remove <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a> from an
App+Stack OAD image</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="s">&quot;$TOOLS_BLE$\oad\oad_image_tool.exe&quot;</span> <span class="s">&quot;$PROJ_DIR$\FlashROM_OAD_Offchip\Exe\simple_peripheral_cc2640r2lp_app.hex&quot;</span> <span class="s">&quot;$PROJ_DIR$\..\stack\FlashROM\Exe\simple_peripheral_cc2640r2lp_stack.hex&quot;</span> <span class="o">-</span><span class="n">t</span> <span class="n">offchip</span> <span class="o">-</span><span class="n">i</span> <span class="n">app</span> <span class="o">--</span><span class="n">imgVer</span> <span class="mi">0</span> <span class="o">-</span><span class="n">ob</span> <span class="s">&quot;$PROJ_DIR$\FlashROM_OAD_Offchip\Exe\simple_peripheral_cc2640r2lp_app_oad.bin&quot;</span> <span class="o">-</span><span class="n">m</span> <span class="mh">0x0000</span> <span class="o">-</span><span class="nl">r</span> <span class="p">:</span><span class="mh">0x1e000</span>
</pre></div>
</div>
</div>
</div></blockquote>
<p>The result will be am OAD image file that will not overwrite a target&#8217;s
31st page (if used for <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a>, adjust as necessary for 2 <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a> pages)</p>
<p>Lastly, for Library builds, there will be 0xFFs between the end of
the Application + Stack merged section and the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a>. If <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a>
is being preserved then it is safe to also trim the OAD image to the nearest
page.</p>
<p>For example, if a Library OAD image is produced, only takes up the
first 15 pages and the <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a> does not need to preserved, then append
<code class="docutils literal"><span class="pre">-r</span> <span class="pre">:0x0F000</span></code> to the post-build step:</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-number">Listing 90. </span><span class="caption-text">Modified IAR post-build step to remove <a class="reference internal" href="../ble-stack-3.x-guide/reference.html#term-49"><span class="xref std std-term">SNV</span></a> and 0xFFs
from a Library OAD image.</span><a class="headerlink" href="#id10" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="s">&quot;$TOOLS_BLE$\oad\oad_image_tool.exe&quot;</span> <span class="s">&quot;$PROJ_DIR$\FlashROM_StackLibrary_OAD_Offchip\Exe\hid_adv_remote_cc2640r2rc_app.hex&quot;</span> <span class="o">-</span><span class="n">t</span> <span class="n">offchip</span> <span class="o">-</span><span class="n">i</span> <span class="n">app</span> <span class="o">--</span><span class="n">imgVer</span> <span class="mi">0</span> <span class="o">-</span><span class="n">ob</span> <span class="s">&quot;$PROJ_DIR$\FlashROM_StackLibrary_OAD_Offchip\Exe\hid_adv_remote_cc2640r2rc_app.bin&quot;</span> <span class="o">-</span><span class="n">m</span> <span class="mh">0x0000</span> <span class="o">-</span><span class="nl">r</span> <span class="p">:</span><span class="mh">0xF000</span>
</pre></div>
</div>
</div>
</div></blockquote>
</div></blockquote>
</li>
</ol>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="oad_onchip.html" class="btn btn-neutral float-right" title="On-Chip OAD" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="oad_profile.html" class="btn btn-neutral" title="OAD Profile" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Texas Instruments.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'3.01.00.05',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>